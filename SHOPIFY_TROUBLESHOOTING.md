# Shopify App Troubleshooting Guide

Reference document for issues encountered and resolved while building the POD Design Generator Shopify app.

---

## Table of Contents

1. [OAuth Token Has Zero Scopes (403 Forbidden)](#1-oauth-token-has-zero-scopes-403-forbidden)
2. [Product Images Not Attaching to Shopify Products](#2-product-images-not-attaching-to-shopify-products)
3. [App Bridge "No Session" Error](#3-app-bridge-no-session-error)
4. [Token Not Persisting (401 on Reload)](#4-token-not-persisting-401-on-reload)
5. [Shopify CLI Setup & Authentication](#5-shopify-cli-setup--authentication)
6. [GraphQL productCreate Mutation Errors (API 2025-10)](#6-graphql-productcreate-mutation-errors-api-2025-10)

---

## 1. OAuth Token Has Zero Scopes (403 Forbidden)

### Symptoms
- `GET /admin/oauth/access_scopes.json` returns `{ "access_scopes": [] }`
- Product publish fails with: `"This action requires merchant approval for write_products scope"`
- Token exists in DB but `grantedScopes` shows empty or `"none"`
- OAuth redirect URL correctly includes `scope=read_products,write_products,...` but Shopify ignores them

### Root Cause
The app's scopes were **not registered on Shopify's servers**. Even though they appeared in the Partner Dashboard UI and in `shopify.app.toml`, Shopify's backend didn't have them linked to the app. The OAuth token exchange returns a token with zero scopes because Shopify doesn't know what scopes to grant.

### Fix
Push the TOML config to Shopify's servers using the Shopify CLI:

```bash
# Install CLI globally
npm install -g @shopify/cli@3.91.0

# Authenticate (opens browser, enter verification code)
shopify auth login

# Deploy config (registers scopes on Shopify's servers)
shopify app deploy --config shopify.app.toml --force
```

After deploying:
1. **Uninstall** the app from the dev store: `https://<store>.myshopify.com/admin/settings/apps`
2. **Reinstall** via OAuth: `https://<app-url>/auth?shop=<store>.myshopify.com`
3. The consent screen should now show the correct permissions
4. Verify with: `GET /api/verify-scopes` — should show all 4 scopes

### Key Files
- `shopify.app.toml` — declares `scopes = "read_products,write_products,read_orders,write_orders"`
- `backend/src/routes/authRoutes.js` — OAuth install/callback flow
- `backend/src/config.js` — `shopify.scopes` array

### Prevention
Always run `shopify app deploy --force` after changing scopes in `shopify.app.toml`.

---

## 2. Product Images Not Attaching to Shopify Products

### Symptoms
- Product is created on Shopify (title, description, tags all correct)
- No images appear on the product listing
- No errors shown to the user

### Root Cause (Two Issues)

**Issue A: Relative image paths**
Images generated by the pipeline are saved locally to `/uploads/<uuid>.png`. When passed to Shopify's image attachment API, Shopify receives a relative path like `/uploads/abc.png` and has no idea which server to download it from.

**Issue B: Deprecated REST endpoint**
In Shopify API version `2025-10`, the REST `POST /products/{id}/images.json` endpoint is deprecated. Images must be attached via the GraphQL `productCreateMedia` mutation.

### Fix

**For relative URLs** — Added `_toPublicUrl()` method in `shopifyPublishService.js`:
```javascript
_toPublicUrl(url) {
  if (!url) return null;
  if (url.startsWith("http://") || url.startsWith("https://")) return url;
  if (this.appBaseUrl && url.startsWith("/")) {
    return `${this.appBaseUrl}${url}`;  
    // e.g., /uploads/abc.png → https://shopify-pod-app-production.up.railway.app/uploads/abc.png
  }
  return url;
}
```

**For image attachment** — Added GraphQL `productCreateMedia` as primary method:
```javascript
async _attachImagesGraphQL(shopDomain, accessToken, productGid, imageUrls) {
  const media = imageUrls.map((url) => ({
    originalSource: url,
    mediaContentType: "IMAGE",
    alt: "Product image",
  }));

  const payload = await this._graphql(shopDomain, accessToken,
    `mutation productCreateMedia($productId: ID!, $media: [CreateMediaInput!]!) {
      productCreateMedia(productId: $productId, media: $media) {
        media { id status }
        mediaUserErrors { field message code }
      }
    }`,
    { productId: productGid, media }
  );
  // Falls back to REST if this fails
}
```

### Key Files
- `backend/src/services/shopifyPublishService.js` — all image attachment logic
- `backend/src/routes/podRoutes.js` — `persistImageUrl()` saves external URLs locally

### Environment Variables Required
- `SHOPIFY_HOST_NAME` — must be set to the public app URL (e.g., `shopify-pod-app-production.up.railway.app`) so relative paths can be resolved. Set this on Railway.

### Prevention
- Always convert relative URLs to absolute public URLs before sending to any external API
- Use GraphQL `productCreateMedia` for Shopify API 2024-04+ (the `images` field on `ProductInput` was removed)

---

## 3. App Bridge "No Session" Error

### Symptoms
- Embedded app loads but all API calls return `{"error":"No session"}`
- App Bridge v4 CDN script is loaded but doesn't initialize properly
- `shopify.idToken()` throws or returns undefined

### Root Cause
The `<script>` tag loading App Bridge was missing the `data-api-key` attribute. Without it, App Bridge doesn't know which app it belongs to and can't generate session tokens.

### Fix
In `web/frontend/index.html`:
```html
<!-- WRONG -->
<script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>

<!-- CORRECT -->
<script data-api-key="fed58333bb62adb69343c109cd77d5ef" 
        src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
```

### Key Files
- `web/frontend/index.html` — App Bridge script tag
- `web/frontend/src/utils/sessionToken.js` — calls `shopify.idToken()`
- `backend/src/services/authService.js` — validates the session token

### Prevention
Always include `data-api-key` with the app's Client ID when loading App Bridge v4.

---

## 4. Token Not Persisting (401 on Reload)

### Symptoms
- App works immediately after install but breaks on page reload
- OAuth callback logs show token being saved, but next request can't find it
- `storeType` shows "JsonStore" instead of "PostgresStore"

### Root Cause
The `DATABASE_URL` environment variable was not linked in Railway. The app fell back to `JsonStore` (in-memory JSON file) which doesn't persist across Railway deployments (ephemeral filesystem).

### Fix
1. In Railway dashboard, link the Postgres service to provide `DATABASE_URL`
2. Verify with the `/health` endpoint — should show `"storeType": "PostgresStore"`
3. Ensure `backend/src/storage/pgStore.js` calls `flush()` after every write

### Key Config
```javascript
// backend/src/config.js
storage: {
  databaseUrl: process.env.DATABASE_URL || process.env.DATABASE_PUBLIC_URL || "",
}
```

### Key Files
- `backend/src/storage/pgStore.js` — PostgreSQL-backed store with `flush()`
- `backend/src/storage/jsonStore.js` — fallback in-memory store (not persistent on Railway)
- `backend/src/routes/authRoutes.js` — calls `store.flush()` after saving token

### Prevention
Always verify `DATABASE_URL` is set on Railway. Check `/health` endpoint for `storeType`.

---

## 5. Shopify CLI Setup & Authentication

### Installation
```bash
# Global install (recommended — local installs had broken bin paths on Windows)
npm install -g @shopify/cli@3.91.0

# Verify
shopify version
```

### Authentication
```bash
# Login (opens browser for Partner account auth)
shopify auth login

# If running from VS Code terminal and interactive prompts don't work,
# open a separate Command Prompt window:
# Win+R → cmd → cd C:\Users\User\Desktop\SHOPIFY → shopify auth login
```

### Deploy Config
```bash
# Push shopify.app.toml to Shopify's servers
shopify app deploy --config shopify.app.toml --force
```

### Common Issues
- **VS Code terminal can't handle interactive prompts**: The integrated terminal sometimes swallows keypresses. Use `Start-Process cmd` or open a standalone Command Prompt.
- **`shopify app config push` not found**: This command doesn't exist. Use `shopify app deploy` instead.
- **Local install broken on Windows**: `npm install --save-dev @shopify/cli` creates a broken `run.cmd` missing `run.js`. Use global install.

---

## 6. GraphQL productCreate Mutation Errors (API 2025-10)

### Symptoms
- `productCreate` mutation fails with schema errors
- Error about `images` field not existing on `ProductInput`

### Root Cause
Shopify API version `2025-10` removed the `images` field from `ProductInput`. Images must be attached separately using `productCreateMedia`.

### Fix Strategy (implemented in `shopifyPublishService.js`)
1. Create product via GraphQL `productCreate` **without** images
2. Attach images via GraphQL `productCreateMedia` (primary)
3. Fall back to REST `POST /products/{id}/images.json` if GraphQL media fails
4. If GraphQL `productCreate` fails entirely, fall back to REST `POST /products.json` with images inline

### Key Mutation
```graphql
mutation productCreate($input: ProductInput!) {
  productCreate(input: $input) {
    product { id handle }
    userErrors { field message }
  }
}
# input does NOT include images — use productCreateMedia separately
```

---

## Environment Variables Reference

| Variable | Purpose | Example |
|----------|---------|---------|
| `SHOPIFY_API_KEY` | App Client ID | `fed58333bb62adb69343c109cd77d5ef` |
| `SHOPIFY_API_SECRET` | App Client Secret | `shpss_...` |
| `SHOPIFY_HOST_NAME` | Public app URL (no protocol) | `shopify-pod-app-production.up.railway.app` |
| `SHOPIFY_SCOPES` | OAuth scopes | `read_products,write_products,read_orders,write_orders` |
| `SHOPIFY_API_VERSION` | API version | `2025-10` |
| `DATABASE_URL` | PostgreSQL connection string | `postgresql://...` |
| `SETUP_SECRET` | Admin setup auth | `myapp-setup-2026-xK9mP` |
| `OPENAI_API_KEY` | OpenAI for image gen | `sk-...` |
| `STABILITY_API_KEY` | Stability AI fallback | `sk-...` |
| `UPLOADS_DIR` | Where images are saved | `/data/uploads` |

---

## Useful Debug Endpoints

| Endpoint | Purpose |
|----------|---------|
| `GET /health` | Check store type, DB connection |
| `GET /api/verify-scopes` | Check granted OAuth scopes |
| `GET /api/debug-auth` | Check token presence and prefix |
| `GET /api/reset-oauth` | Clear stored token (forces re-auth) |

---

## Quick Checklist for New Deployments

- [ ] `DATABASE_URL` linked in Railway
- [ ] `SHOPIFY_HOST_NAME` set to public Railway URL
- [ ] `shopify app deploy --force` run after any scope changes
- [ ] App Bridge `data-api-key` set in `index.html`
- [ ] App uninstalled and reinstalled after scope changes
- [ ] `/health` shows `PostgresStore`
- [ ] `/api/verify-scopes` shows all expected scopes
